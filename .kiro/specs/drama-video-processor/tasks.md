# 实现计划：短剧视频批量处理工具

## 概述

本实现计划将设计文档转换为可执行的开发任务。系统使用 Python 实现，基于 FFmpeg 进行视频处理，支持并发处理、断点续传和多种字幕格式。

## 任务

- [x] 1. 设置项目结构和核心接口
  - 创建项目目录结构
  - 定义核心数据类和枚举（ProcessingStatus, SubtitleFormat 等）
  - 实现基础接口（VideoProcessor, ProgressCallback）
  - 设置依赖管理（requirements.txt）
  - _需求：6.1, 6.2, 6.3_

- [x] 2. 实现文件排序和扫描功能
  - [x] 2.1 实现 FileSorter 类
    - 实现自然排序算法（natural_sort_key）
    - 实现序列验证（validate_sequence）
    - 支持多种文件命名格式
    - _需求：1.2, 1.3_

  - [x] 2.2 编写 FileSorter 的属性测试
    - **属性 1：文件排序一致性**
    - **属性 28：自然排序正确性**
    - **属性 29：序列连续性检测**
    - **属性 30：序列重复检测**
    - **验证需求：1.2, 1.3**

  - [x] 2.3 实现 DirectoryScanner 类
    - 扫描 drama/ 根目录
    - 识别 drama-XXXX 命名模式
    - 验证目录结构（video/, srt/, merged/, cleared/）
    - _需求：5.1, 5.2, 5.3, 5.4_

  - [x] 2.4 编写 DirectoryScanner 的单元测试
    - 测试目录模式识别
    - 测试目录验证逻辑
    - **验证需求：5.1, 5.2, 5.3, 5.4**

- [x] 3. 实现字幕解析和处理
  - [x] 3.1 实现 SRT 格式解析器
    - 实现 SRTParser 类
    - 解析 SRT 时间戳格式
    - 格式化 SRT 输出
    - _需求：1.3, 1.5_

  - [x] 3.2 实现 ASS 格式解析器
    - 实现 ASSParser 类
    - 解析 ASS 时间戳和样式
    - 保留 ASS 头部信息
    - _需求：1.3, 1.5_

  - [x] 3.3 实现 SubtitleFile 类
    - 自动格式检测
    - 时间戳偏移功能
    - 保存为原格式
    - _需求：1.5, 1.7_

  - [x] 3.4 编写字幕处理的属性测试
    - **属性 3：字幕格式自动检测**
    - **属性 4：字幕格式保持**
    - **属性 9：字幕时间戳偏移**
    - **属性 10：字幕时间戳单调性**
    - **验证需求：1.3, 1.5, 1.7**

- [x] 4. 实现 FFmpeg 包装器
  - [x] 4.1 实现基础 FFmpegWrapper 类
    - 执行 FFmpeg 命令
    - 获取视频信息（时长、分辨率）
    - 解析 FFmpeg 输出
    - _需求：1.4, 2.2, 3.3_

  - [x] 4.2 实现 OptimizedFFmpegWrapper 类
    - GPU 编码器检测
    - 构建优化的转码命令
    - 构建快速合并命令（concat demuxer）
    - _需求：性能优化_

  - [x] 4.3 编写 FFmpeg 包装器的单元测试
    - 测试命令构建
    - 测试视频信息提取
    - **验证需求：1.4, 2.2, 3.3**

- [x] 5. 检查点 - 确保基础组件测试通过
  - 确保所有测试通过，如有问题请询问用户

- [x] 6. 实现视频合并模块
  - [x] 6.1 实现 VideoMerger 类
    - 扫描和排序视频片段
    - 扫描和排序字幕片段（支持 SRT/ASS）
    - 合并视频文件
    - 合并字幕文件并调整时间戳
    - _需求：1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7_

  - [x] 6.2 编写视频合并的属性测试
    - **属性 8：视频合并时长守恒**
    - **验证需求：1.4**

  - [x] 6.3 编写视频合并的单元测试
    - 测试无字幕合并
    - 测试视频文件缺失处理
    - **验证需求：1.9, 1.10**

- [x] 7. 实现音频分离模块
  - [x] 7.1 实现 AudioSeparator 类
    - 提取音频轨道
    - 集成 Spleeter/Demucs 进行音频分离
    - 替换视频音频轨道
    - 保持视频属性（分辨率、编码）
    - _需求：2.1, 2.2, 2.3, 2.4, 2.5_

  - [x] 7.2 编写音频分离的属性测试
    - **属性 11：音频提取时长一致性**
    - **属性 12：视频属性保持**
    - **属性 13：音频替换后视频时长不变**
    - **验证需求：2.2, 2.4, 2.5**

  - [x] 7.3 编写音频分离的单元测试
    - 测试 merged/ 目录不存在处理
    - 测试音频分离失败恢复
    - **验证需求：2.10, 2.11**

- [x] 8. 实现视频转码模块
  - [x] 8.1 实现 VideoTranscoder 类
    - 定义转码规格（1080p, 720p, 480p）
    - 获取视频分辨率
    - 转码视频（保持宽高比）
    - 分辨率检查和跳过逻辑
    - _需求：3.1, 3.2, 3.3, 3.4, 3.8, 3.11_

  - [x] 8.2 编写视频转码的属性测试
    - **属性 14：转码编码格式验证**
    - **属性 15：转码文件命名格式**
    - **属性 16：宽高比保持**
    - **属性 17：分辨率跳过逻辑**
    - **验证需求：3.3, 3.4, 3.8, 3.11**

  - [x] 8.3 编写视频转码的单元测试
    - 测试 cleared/ 目录不存在处理
    - 测试多规格转码
    - **验证需求：3.2, 3.10**

- [x] 9. 检查点 - 确保核心处理模块测试通过
  - 确保所有测试通过，如有问题请询问用户

- [x] 10. 实现进度跟踪和错误处理
  - [x] 10.1 实现 ProgressTracker 和 ProgressCallback
    - 跟踪任务进度
    - 计算进度百分比
    - 回调接口实现
    - _需求：4.1, 4.2, 4.3_

  - [x] 10.2 实现 ErrorHandler 和错误恢复策略
    - 错误分类和处理
    - 重试策略
    - 跳过策略
    - _需求：4.4, 4.6_

  - [x] 10.3 实现 ProcessingLogger
    - 记录任务开始/完成/错误
    - 记录验证错误
    - 生成批量处理摘要
    - _需求：4.4, 4.5_

  - [x] 10.4 编写进度和错误处理的单元测试
    - 测试进度计算
    - 测试错误恢复
    - **验证需求：4.3, 4.6**

- [x] 11. 实现并发处理和任务编排
  - [x] 11.1 实现 Orchestrator 基类
    - 协调各模块执行
    - 管理任务队列
    - 处理单个短剧目录
    - _需求：1.8, 2.9, 3.9_

  - [x] 11.2 实现 ConcurrentOrchestrator
    - 线程池并发处理
    - 线程安全的进度更新
    - 自动调整并发数
    - _需求：性能优化_

  - [x] 11.3 编写并发处理的属性测试
    - **属性 18：批量处理完整性**
    - **属性 19：错误隔离**
    - **属性 25：并发处理结果完整性**
    - **属性 26：并发处理线程安全**
    - **验证需求：1.8, 4.6**

- [x] 12. 实现断点续传功能
  - [x] 12.1 实现 StateManager
    - 状态持久化（JSON）
    - 加载和保存状态
    - 检查任务完成状态
    - 输出文件验证
    - _需求：用户要求_

  - [x] 12.2 实现 ResumableOrchestrator
    - 过滤已完成任务
    - 更新任务状态
    - 支持跳过已完成
    - _需求：用户要求_

  - [x] 12.3 编写断点续传的属性测试
    - **属性 27：状态持久化一致性**
    - **属性 28：已完成任务跳过**
    - **属性 29：输出文件验证**
    - **验证需求：用户要求**

- [x] 13. 实现详细报告功能
  - [x] 13.1 实现 DetailedProcessingReport
    - 收集成功/失败/跳过任务
    - 计算统计信息
    - 生成 JSON 报告
    - 打印摘要
    - _需求：4.5, 用户要求_

  - [x] 13.2 实现 ReportingOrchestrator
    - 生成详细报告
    - 保存报告文件
    - _需求：4.5, 用户要求_

  - [x] 13.3 编写报告功能的属性测试
    - **属性 31：报告统计一致性**
    - **属性 32：失败任务错误信息完整性**
    - **属性 33：报告序列化往返一致性**
    - **验证需求：4.5**

- [x] 14. 检查点 - 确保高级功能测试通过
  - 确保所有测试通过，如有问题请询问用户

- [x] 15. 实现命令行接口
  - [x] 15.1 实现 CLI 参数解析
    - 使用 argparse 或 click
    - 定义命令（merge, separate, transcode）
    - 解析配置参数
    - _需求：6.1, 6.2, 6.3, 6.5_

  - [x] 15.2 实现主程序入口
    - 初始化配置
    - 调用相应的处理模块
    - 显示进度和结果
    - _需求：6.4, 6.5_

  - [x] 15.3 编写 CLI 的集成测试
    - 测试各命令独立运行
    - 测试参数解析
    - **验证需求：6.1, 6.2, 6.3, 6.4, 6.5**

- [x] 16. 实现文件管理功能
  - [x] 16.1 实现目录自动创建
    - 创建输出目录（merged/, cleared/, encoded/）
    - _需求：5.7_

  - [x] 16.2 实现文件命名冲突处理
    - 检测同名文件
    - 添加数字后缀
    - _需求：5.9_

  - [x] 16.3 实现文件复制功能
    - 复制字幕文件到输出目录
    - _需求：2.8, 3.7_

  - [x] 16.4 编写文件管理的属性测试
    - **属性 6：文件复制一致性**
    - **属性 7：文件命名冲突处理**
    - **属性 23：输出目录自动创建**
    - **验证需求：2.8, 3.7, 5.7, 5.9**

- [x] 17. 性能优化实现
  - [x] 17.1 实现资源监控
    - CPU 和内存使用监控
    - 峰值记录
    - _需求：性能优化_

  - [x] 17.2 实现内存优化
    - 流式字幕处理
    - 及时释放资源
    - _需求：性能优化_

  - [x] 17.3 实现磁盘 I/O 优化
    - 同磁盘临时目录
    - 原子写入
    - 磁盘空间检查
    - _需求：性能优化_

  - [x] 17.4 编写性能测试
    - 测试并发性能
    - 测试内存使用
    - **验证需求：性能优化**

- [x] 18. 集成测试和端到端测试
  - [x] 18.1 创建测试数据生成器
    - 生成测试视频文件
    - 生成测试字幕文件
    - 创建测试目录结构
    - _需求：测试_

  - [x] 18.2 编写完整流水线测试
    - 测试 video/ → merged/ → cleared/ → encoded/ 完整流程
    - 测试多短剧批量处理
    - **验证需求：所有需求**

  - [x] 18.3 编写边缘情况测试
    - 测试空目录
    - 测试文件缺失
    - 测试格式错误
    - **验证需求：1.9, 1.10, 2.10, 2.11, 3.10**

- [x] 19. 文档和配置
  - [x] 19.1 编写 README.md
    - 项目介绍
    - 安装说明
    - 使用示例
    - _需求：文档_

  - [x] 19.2 编写配置文件示例
    - 创建 config.example.json
    - 说明配置选项
    - _需求：文档_

  - [x] 19.3 编写开发者文档
    - 架构说明
    - API 文档
    - 贡献指南
    - _需求：文档_

- [x] 20. 最终检查点 - 完整系统测试
  - 运行所有测试
  - 验证所有需求
  - 性能基准测试
  - 确保所有测试通过，如有问题请询问用户

## 注意事项

- 所有任务都是必需的，包括测试任务
- 每个任务都引用了相关的需求编号
- 属性测试使用 `hypothesis` 库，最少 100 次迭代
- 单元测试使用 `pytest` 框架
- 检查点任务用于确保增量验证
- 测试覆盖率目标：核心功能 90%+，整体 80%+
